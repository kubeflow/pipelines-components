---
name: Build and Test Python Packages

# Reusable build/validation workflow; callable via push/PR or workflow_call.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_call:
    inputs:
      python_versions:
        description: 'JSON array of Python versions for the matrix, e.g. ["3.11","3.13"]'
        required: false
        type: string
        default: '["3.11","3.13"]'
      publish_packages:
        description: 'Set true to build from sdist and publish to PyPI'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write  # Required when publishing via Trusted Publishing
    # Flag release mode based on trigger inputs or tagged builds.
    env:
      SHOULD_PUBLISH: >-
        ${{ (github.event_name == 'workflow_call' && inputs.publish_packages)
            || (github.event_name != 'workflow_call'
            && (github.ref matches '^refs/tags/v[0-9]+\\.[0-9]+\\.[0-9]+$')) }}
    strategy:
      matrix:
        python-version: >-
          ${{ fromJson(
            github.event_name == 'workflow_call' && inputs.python_versions != ''
              ? inputs.python_versions
              : '["3.11","3.13"]'
          ) }}

    name: Build packages (Python ${{ matrix.python-version }})

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Needed for proper versioning

      - name: Setup Python CI
        uses: ./.github/actions/setup-python-ci
        with:
          python-version: ${{ matrix.python-version }}

      # Release-mode builders regenerate artifacts from the sdist and validate metadata.
      - name: Install build tools for release artifacts
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine

      - name: Build release sdist
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          rm -rf dist
          python -m build --sdist --outdir dist

      - name: Rebuild wheel from sdist
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          set -eux
          tmp_dir="$(mktemp -d)"
          sdist_path="$(ls dist/*.tar.gz)"
          tar -xzf "$sdist_path" -C "$tmp_dir"
          sdist_root="$(find "$tmp_dir" -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          python -m build --wheel --outdir "$tmp_dir/dist" "$sdist_root"
          cp "$tmp_dir/dist"/*.whl dist/

      - name: Run Twine checks
        if: env.SHOULD_PUBLISH == 'true'
        run: |
          python -m twine check dist/*

      # Validation path: standard build/test workflow across matrix versions.
      - name: Build Package
        if: env.SHOULD_PUBLISH != 'true'
        run: |
          echo "Building package (kfp-components)..."
          uv build --out-dir dist/
          echo "Package built successfully"
          ls -lah dist/

      - name: Validate Wheel Contents
        run: |
          echo "Validating package wheel contents..."
          for wheel in dist/*.whl; do
            python .github/scripts/validate_wheel/validate_wheel.py "$wheel"
          done

      - name: Create test environment
        run: |
          uv venv test-env
          echo "Virtual environment created"

      - name: Test Package Installation and Imports
        run: |
          echo "Installing package..."
          uv pip install --python test-env dist/*.whl

          echo "Testing package imports..."
          test-env/bin/python .github/scripts/package_imports/package_imports.py

      - name: Validate Package Metadata
        run: |
          echo "Extracting and validating package metadata..."
          for wheel in dist/*.whl; do
            echo "Validating package metadata: $wheel"
            python .github/scripts/validate_wheel/validate_wheel.py "$wheel"
          done

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: package-py${{ matrix.python-version }}
          path: dist/
          retention-days: 30

      - name: Publish to PyPI
        if: env.SHOULD_PUBLISH == 'true' && matrix.python-version == '3.11'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
